#!/bin/sh
# $Id$
# Generate makefile dependencies for gkw .[fF]90 files
#
# phsgbq : 28-11-2008 created
#          11-08-2010 enable using the objects file to create the deps
#
# - If a filename is passed to this script, any strings matching *.o in that
#   file will be taken as dependencies that need to be generated using source
#   files found in the same directory as that file.
# - If run without a filename, any file matching .*90 in the current directory
#   will be assumed to be needing dependencies to be generated.
#
# - External modules should not be matched (so there is a filter for omp_lib).
# - Included files will be put into dependencies if they are not related to
#   the external libraries (e.g. mpif.h). ("fftw*.h" etc. are not matched at
#   present because they appear upper case in that module.)

# generate list of file prefixes from files having dependencies
if [ ! -z "$1" ]; then
    file_prefixes=`sed -e 's/[[:graph:]]*\.o/\#&\#/g' $1 | tr '\#' '\n' | grep '\.o' |  sed -e 's/\.o.*$//g' | sort | uniq`
    sourcedir=`dirname $1`
else
    file_prefixes=`ls | grep '\.[fF]90' | grep -E -v "#|~" | sed -e 's/\.[fF]90//g'`
    sourcedir="."
fi

mmm=""
echo "###### file generated by scripts/mkdeps ######"
echo ""
for i in $file_prefixes
do
    # If a "use somemodule" statement appears in a source module, put
    # "somemodule.mod" into the list of object dependencies.
    k=$(grep  '^[[:space:]]*use ' $sourcedir/$i.*90 | tr '[:upper:]' '[:lower:]' | sed -e 's/^[[:space:]]*use[[:space:]]*//' -e 's/[[:space:]]//g' -e 's/\,.*$//g' | sort | uniq | tr '\n' '.' | sed -e 's/\./\.mod /g' )

    mmm="${mmm} ${k}"
  
    # If "include 'somefile.h'" appears in a source module, put
    # "somefile.h" into the list of included file dependencies.
    m=$(grep  '^\#include' $sourcedir/$i.*90 | $FILTER2 | $FILTER3 | $FILTER4 | sed -e 's/^\#include//g' -e "s/'//g" -e 's/[[:space:]]*//g' -e 's/\"//g' )

   echo "$i.o: $k" 
done


#mmm=`echo $mmm | tr ' ' '\n' | sort | uniq | tr '\n' ' '`
#echo "MODULES    = ${mmm}"

#mmm=`echo $mmm | tr ' ' '\n' | sort | uniq`
#
#for i in $mmm
#do
#    filename=$(basename "$i")
#    extension="${filename##*.}"
#    filename="${filename%.*}"
#    kk=`grep -i ${filename} *.[fF]90 vtk/*.[fF]90 | grep -i 'module' | tr '\n' ':' | sed -e 's/\..*//'`
#    [ z"${kk}" == "z" ] || echo "${filename}.mod: ${kk}.o"
#done
