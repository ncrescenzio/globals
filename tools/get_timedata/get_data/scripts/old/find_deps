#!/bin/sh
# generate list of file prefixes from files having dependencies
if [ ! -z "$1" ]; then
    file_prefixes=`sed -e 's/[[:graph:]]*\.o/\#&\#/g' $1 | tr '\#' '\n' | grep '\.o' |  sed -e 's/\.o.*$//g' | sort | uniq`
    sourcedir=`dirname $1`
else
    file_prefixes=`ls | grep '\.[fF]90' | grep -E -v "#|~" | sed -e 's/\.[fF]90//g'`
    sourcedir="."
fi

mmm=""
echo "###### file generated by scripts/find_mod_names ######"
echo ""
for i in $file_prefixes
do
    # If a "module somemodule" statement appears in a source module, put
    # "somemodule.mod" into the list 
    k=$(grep  '^[[:space:]]*module ' $sourcedir/$i.*90 | grep -i -v 'procedure' | tr '[:upper:]' '[:lower:]' | sed -e 's/^[[:space:]]*module[[:space:]]*//' -e 's/[[:space:]]//g' -e 's/\,.*$//g' | sort | uniq | tr '\n' '.' | sed -e 's/\./\.mod /g' )

    mmm="${mmm} ${k}"
done


mmm=`echo $mmm | tr ' ' '\n' | sort | uniq | tr '\n' ' '`
echo "MODS    = \$(LIBMODS) ${mmm}"


#mmm=`echo $mmm | tr ' ' '\n' | sort | uniq`
#
#for i in $mmm
#do
#    filename=$(basename "$i")
#    extension="${filename##*.}"
#    filename="${filename%.*}"
#    kk=`grep -i ${filename} *.[fF]90 vtk/*.[fF]90 | grep -i 'module' | tr '\n' ':' | sed -e 's/\..*//'`
#    [ z"${kk}" == "z" ] || echo "${filename}.mod: ${kk}.o"
#done
